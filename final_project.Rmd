---
title: "final_project"
author: "Shiyuan Wang"
date: "4/6/2021"
output: pdf_document
---

```{r, echo = TRUE, message=FALSE,warning = FALSE}
#LIBRARIES
library(quantmod)
library(tidyquant)
library(fs)
library(jsonlite)
library(httr)
library(XML)
library(rvest)
library(ggplot2)
library(dplyr)
library(googleLanguageR)
```

```{r, echo = TRUE, message=FALSE}
#Final project
##Extracting S&P500 data from the packages
stock_list_tbl <- tq_index("SP500") %>%
  select(symbol, company, weight) %>% 
  arrange(desc(weight))
symbol <- stock_list_tbl$symbol[1:20]
symbol <- symbol[-8]###I do not know how to extract data of BRK.B, so I just delete it.
stock_data <- tq_get(symbol, get = "stock.prices",
                     from = "2021-01-01",to= "2021-04-01")
```

```{r, echo = TRUE} 
stock_data <- stock_data %>% 
  select(symbol, date, open, high, low, close)
stock_data
```


```{r, echo = TRUE} 
### Extract New York Times data
get.ny <- function(a){
  NYTIMES_KEY = "LXrkrR8vlr0RnqKwoA7we3dyCngAdEPk"
  
  x <- fromJSON(paste0("http://api.nytimes.com/svc/search/v2/articlesearch.json?q=",a,"&api-key=LXrkrR8vlr0RnqKwoA7we3dyCngAdEPk", sep=""), flatten = TRUE) %>% data.frame()
  
  list(name = c("persons", "organizations", "subject"), value = c("Stock"), rank = 1:3, major = c("N", "N", "N"))
  # Need to use + to string together separate words
  begin_date <- "20210101"
  end_date <- "20210401"
  baseurl <- paste0("http://api.nytimes.com/svc/search/v2/articlesearch.json?q=",a,
                    "&begin_date=",begin_date,"&end_date=",end_date,
                    "&facet_filter=true&api-key=",NYTIMES_KEY, sep="")
  
  initialQuery <- fromJSON(baseurl)
  maxPages <- round((initialQuery$response$meta$hits[1] / 10)-1) 
  pages <- list()
  for(i in 0:3){
    nytSearch <- fromJSON(paste0(baseurl, "&page=", i), flatten = TRUE) %>% data.frame() 
    message("Retrieving page ", i)
    pages[[i+1]] <- nytSearch 
    Sys.sleep(10) 
  }
  allNYTSearch <- rbind_pages(pages)
  return(allNYTSearch)
}
```

```{r, echo = TRUE}
company.names <- stock_list_tbl$company[1:2]
ny.data <- data.frame()
for (i in as.factor(company.names)){
  i.data <- get.ny(i)
  ny.data <- rbind(ny.data,i.data)
}
data <- ny.data[-75,]
```


```{r, echo = TRUE, message=FALSE,warning = FALSE} 
###Google Api sentiment analysis
if (!"devtools" %in% installed.packages()) {
  install.packages("devtools")
}
devtools::install_github("mkearney/googleapis")
library(googleapis)
sentiment.score <- c()
for (i in 1:nrow(data)){
  sa <- analyze_sentiment(data$response.docs.abstract[i])
  sa <- as.data.frame(sa)
  sentiment.score <- c(sentiment.score, mean(sa$score))
}
sentiment.score

```


